version: 2.1
orbs:
  gh: circleci/github-cli@2.1.0
jobs:
  - build:
    docker:
      - image: cimg/rust
    steps:
      - checkout
      - run:
          name: Install and set Linuxbrew
          command: |
            sudo apt install -y build-essential curl file git
            sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)"

            echo 'export PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin/:$PATH"' >> $BASH_ENV
            echo 'export MANPATH="/home/linuxbrew/.linuxbrew/share/man:$MANPATH"' >> $BASH_ENV
            echo 'export INFOPATH="/home/linuxbrew/.linuxbrew/share/info:$INFOPATH"' >> $BASH_ENV

            brew install gh
      - run:
        name: Package
        command: |
          cargo build --release
          cd target/release
          tar cjf homebrew-pck.tar.bz2 rc_bin
      - run:
        name: Publish
        command: gh release create latest homebrew-pck.tar.bz2
